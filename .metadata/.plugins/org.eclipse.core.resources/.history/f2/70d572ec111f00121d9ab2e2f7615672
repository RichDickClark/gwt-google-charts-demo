package edu.mit.ll.irbenchmark;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import javax.persistence.CollectionTable;
import javax.persistence.Column;
import javax.persistence.ElementCollection;
import javax.persistence.Embeddable;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import edu.mit.ll.div4.grp42.clark.util.GitSha;

/**
 * A collection of TruthData generated by fusing
 * multiple survey responses.  Note that when 
 * TruthData objects are added to a TruthDataset,
 * one must explicitly call addTopicRelevanceTruthData()
 * as opposed to just addTruthData() for those questions
 * that pertain to the relevance of a document to a
 * particular topic.  
 * @author Clark Williams
 *
 */
@Entity
public class TruthDataset implements edu.mit.ll.irbenchmark.SocialMediaBenchmarksDatabase.Persistent {

	/**
	 * Start a new truth dataset for the given collection of documents
	 * @param corpus The collection of documents this data set provides information about
	 */
	public TruthDataset( CorpusName corpus ) {
		this(corpus,false,"");
	}
	
	/**
	 * Start a new truth dataset for the given collection of documents
	 * @param corpus The collection of documents this data set provides information about
	 * @param description Human readable description of this truth data set
	 */
	public TruthDataset( CorpusName corpus, String description ) {
		this(corpus,false,description);
	}	
	
	/**
	 * Start a new truth dataset for the given collection of documents.
	 * Note that for "gold truth" data sets the parameter isTrusted should be set to true.  
	 * @param corpus The collection of documents this data set provides information about
	 * @param isTrusted If true it indicates that this data set contains responses from trusted workers only 
	 * @param description Human readable description of this truth data set
	 */
	public TruthDataset( CorpusName corpus, boolean isTrusted, String description ) {
		this.corpus = corpus;
		this.isTrusted = isTrusted;
		this.description = description;
	}
	
	@SuppressWarnings("unused")
	private TruthDataset() {		
	}
	
	/**
	 * Retrieve the most recently saved TruthDataset
	 * @return
	 */
	public static TruthDataset loadLatest( CorpusName corpus ) {
		return SocialMediaBenchmarksDatabase.loadLatestTruthDataset(corpus);
	}
	
	/**
	 * Return how relevance a given document is to a topic of interest according to this truth dataset
	 * @param documentId unique identifier of a document from the corpus
	 * @param topic topic of interest 
	 * @return value from 0.0 to 1.0 giving relevance to topic, or null if this dataset doesn't contain that information
	 */
	public Double getTopicRelevanceTruthData( long documentId, Topic topic ) {
		Double trueAnswer = this.topicRelevanceTruthData.get(new DocTopic(documentId,topic));
		if( trueAnswer==null )
			return null;
		return (trueAnswer-1.0)/4.0;
	}
	
	/**
	 * Provide the estimated true answer to one of the survey 
	 * questions on how relevance a document is to a particular
	 * topic of interest.  
	 * @param documentId unique identifier of a document
	 * @param questionNumber number of a question from the survey (valid values 1 through 6)
	 * @param answer estimated correct response to that question (valid values 1.0 through 5.0)
	 * @param topic which topic of interest the question is asking about
	 */
	public void addTopicRelevanceTruthData( long documentId, int questionNumber, Topic topic, double answer ) {
		truthData.put( new DocQuestion(documentId,questionNumber), answer );
		topicRelevanceTruthData.put( new DocTopic(documentId,topic), answer );
	}

	/**
	 * Return the estimated true answer to a question on the survey,
	 * corresponding to a particular facet of a document. 
	 * @param documentId unique identifier of a document
	 * @param questionNumber number of a question from the survey (valid values 1 through 11)
	 * @return value from 1.0 to 5.0 giving estimated answer, or null if this dataset doesn't contain that information
	 */
	public Double getTruthData( long documentId, int questionNumber ) {
		return this.truthData.get(new DocQuestion(documentId,questionNumber));
	}
	
	/**
	 * Provide the estimated true answer to a question on the survey,
	 * corresponding to a particular facet of a document.
	 * Note that for questions pertaining to topic relevance
	 * method addTopicRelevanceTruthData should be called instead.  
	 * @param documentId unique identifier of a document
	 * @param questionNumber number of a question from the survey (valid values 1 through 11)
	 * @param answer estimated correct response to that question (valid values 1.0 through 5.0)
	 */
	public void addTruthData( long documentId, int questionNumber, double answer ) {
		truthData.put( new DocQuestion(documentId,questionNumber), answer );		
	}
	
	@Id
	@GeneratedValue
	private long id;
	
	@Column(nullable=false)
	private CorpusName corpus;
	
	public CorpusName getCorpus() {
		return corpus;
	}

	@Column(nullable=false)
	private Date creationDate = new Date();
	
	/**
	 * Is this "gold standard" truth data created only from responses from trusted workers
	 */
	private boolean isTrusted;
	
	public boolean getIsTrusted() {
		return isTrusted;
	}
	
	private String description;
	
	/**
	 * SHA-1 hash of the git commit of the codebase that generated this truth data
	 */
	@Column(nullable=false)
	private String benchmarkCodeVersion = GitSha.sha;
	
	public String getBenchmarkCodeVersion() {
		return benchmarkCodeVersion;
	}

	@Embeddable
	private static class DocQuestion {
		public DocQuestion( long documentId, int questionNumber ) {
			this.documentId = documentId;
			this.questionNumber = questionNumber;
		}
		@SuppressWarnings("unused")
		private DocQuestion() {}
		private long documentId;
		private int questionNumber;
		@Override
		public int hashCode() {
			final int prime = 31;
			int result = 1;
			result = prime * result + (int) (documentId ^ (documentId >>> 32));
			result = prime * result + questionNumber;
			return result;
		}
		@Override
		public boolean equals(Object obj) {
			if (this == obj)
				return true;
			if (obj == null)
				return false;
			if (getClass() != obj.getClass())
				return false;
			DocQuestion other = (DocQuestion) obj;
			if (documentId != other.documentId)
				return false;
			if (questionNumber != other.questionNumber)
				return false;
			return true;
		}
	}
	
	/**
	 * Truth data indexed by document id and question number
	 */
    @ElementCollection
    @Column(name="trueAnswer")
    @CollectionTable(name="TruthData", joinColumns=@JoinColumn(name="datasetId"))
	private Map<DocQuestion,Double> truthData = new HashMap<DocQuestion,Double>();
	
	@Embeddable
	private static class DocTopic {
		public DocTopic(long documentId, Topic topic) {
			super();
			this.documentId = documentId;
			this.topic = topic;
		}
		@SuppressWarnings("unused")
		private DocTopic() {}
		private long documentId;
		private Topic topic;
		@Override
		public int hashCode() {
			final int prime = 31;
			int result = 1;
			result = prime * result + (int) (documentId ^ (documentId >>> 32));
			result = prime * result + ((topic == null) ? 0 : topic.hashCode());
			return result;
		}
		@Override
		public boolean equals(Object obj) {
			if (this == obj)
				return true;
			if (obj == null)
				return false;
			if (getClass() != obj.getClass())
				return false;
			DocTopic other = (DocTopic) obj;
			if (documentId != other.documentId)
				return false;
			if (topic != other.topic)
				return false;
			return true;
		}
		
	}

	/**
	 * Truth data on document relevance to topics of interest
	 */
    @ElementCollection
    @Column(name="trueAnswer")
    @CollectionTable(name="TopicRelevanceTruthData", joinColumns=@JoinColumn(name="datasetId"))
	private Map<DocTopic,Double> topicRelevanceTruthData = new HashMap<DocTopic,Double>();

	public Date getCreationDate() {
		return creationDate;
	}

	public String getDescription() {
		return description;
	}
	
}
